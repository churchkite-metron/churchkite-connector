name: release-zip

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Prepare artifact
        run: |
          set -e
          mkdir -p dist build/churchkite-connector
          rsync -a --exclude ".git" --exclude ".github" --exclude "dist" --exclude "build" ./ build/churchkite-connector/
          cd build
          zip -r ../dist/churchkite-connector.zip churchkite-connector
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/churchkite-connector.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Publish to ChurchKite Admin
        uses: actions/github-script@v7
        env:
          PUBLISH_URL: ${{ secrets.CK_PUBLISH_URL }}
          PUBLISH_KEY: ${{ secrets.CK_PUBLISH_KEY }}
        with:
          script: |
            const slug = 'churchkite-connector';
            const tag = process.env.GITHUB_REF_NAME || context.ref.replace('refs/tags/','');
            const version = tag.replace(/^v/i,'');
            const { data: rel } = await github.rest.repos.getReleaseByTag({ owner: context.repo.owner, repo: context.repo.repo, tag });
            const asset = (rel.assets || []).find(a => a.name === 'churchkite-connector.zip');
            if (!asset) core.setFailed('Release asset not found: churchkite-connector.zip');
            const payload = {
              slug,
              version,
              url: rel.html_url,
              assetApiUrl: asset.url,
              changelog: rel.body || '',
            };
            const res = await fetch(process.env.PUBLISH_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'x-publish-key': process.env.PUBLISH_KEY },
              body: JSON.stringify(payload),
            });
            const text = await res.text();
            core.info(`Publish status ${res.status} body: ${text}`);
            if (!res.ok) {
              core.setFailed(`Publish failed: ${res.status} ${text}`);
            }
      - name: Upload asset to ChurchKite Admin
        env:
          PUBLISH_URL: ${{ secrets.CK_PUBLISH_URL }}
          PUBLISH_KEY: ${{ secrets.CK_PUBLISH_KEY }}
        run: |
          set -e
          SLUG="churchkite-connector"
          TAG="${GITHUB_REF_NAME}"
          VER="${TAG#v}"
          UPLOAD_URL="${PUBLISH_URL/publish/upload}"
          if [ ! -f "dist/${SLUG}.zip" ]; then echo "Zip not found: dist/${SLUG}.zip"; ls -la dist; exit 1; fi
          RESULT=$(curl -sS -w "\n%{http_code}" -X POST \
            -H "x-publish-key: ${PUBLISH_KEY}" \
            -H "Content-Type: application/zip" \
            --data-binary @"dist/${SLUG}.zip" \
            "${UPLOAD_URL}?slug=${SLUG}&version=${VER}")
          HTTP_CODE=$(echo "$RESULT" | tail -n1)
          BODY=$(echo "$RESULT" | sed '$d')
          echo "Response: $BODY"
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Upload failed with status $HTTP_CODE"
            exit 1
          fi
      - name: Verify Admin download integrity
        env:
          ADMIN_BASE: ${{ secrets.CK_ADMIN_VERIFY_URL }}
        run: |
          set -e
          SITE="${ADMIN_BASE:-https://phpstack-962122-6023915.cloudwaysapps.com}"
          curl -sS -D - "$SITE/api/updates/check?slug=churchkite-connector"
          curl -sSf -o /tmp/ckc.zip "$SITE/api/updates/download?slug=churchkite-connector"
          wc -c /tmp/ckc.zip
          unzip -t /tmp/ckc.zip
