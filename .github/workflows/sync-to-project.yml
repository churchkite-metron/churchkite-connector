# sync-to-project.yml
# Adds issues to Project and dynamically sets Pillar based on Repo Topics
# Version: 1.1.0
# ------------------------------------------------
# PROJECT METADATA REFERENCE
# Project: #12 (churchkite-metron)
# Project ID: PVT_kwDOC_W5-c4BLOYo
# Field (Pillar) ID: PVTSSF_lADOC_W5-c4BLOYozg63fEA
# ------------------------------------------------

name: Sync to Project Board
on:
  issues:
    types: [opened]

jobs:
  triage:
    runs-on: ubuntu-latest
    env:
      # Moving token to job level for broader access
      GH_TOKEN: ${{ secrets.GH_PROJECT_PAT }}
      PROJECT_ID: "PVT_kwDOC_W5-c4BLOYo"
      FIELD_ID: "PVTSSF_lADOC_W5-c4BLOYozg63fEA"
    steps:
      - name: Add to Project and Auto-Match Pillar
        run: |
          # 1. Add issue to project
          echo "Adding issue to Project #12..."
          ITEM_ID=$(gh project item-add 12 --owner "churchkite-metron" --url "${{ github.event.issue.html_url }}" --format json | jq -r '.id')

          if [ "$ITEM_ID" == "null" ]; then
            echo "Error: Could not add to project."
            exit 1
          fi

          # 2. Get Repository Topics
          TOPICS=$(gh api repos/${{ github.repository }}/topics --jq '.names[]')
          echo "Detected Topics: $TOPICS"

          # 3. Fetch ALL available Pillar options from the Board
          echo "Fetching Pillar options from Board..."
          PILLAR_OPTIONS=$(gh api graphql -f query='
            query($project_id: ID!) {
              node(id: $project_id) {
                ... on ProjectV2 {
                  field(name: "Pillar") {
                    ... on ProjectV2SingleSelectField {
                      options { id name }
                    }
                  }
                }
              }
            }' -f project_id="$PROJECT_ID" --jq '.data.node.field.options')

          # 4. Search for a match (The Truly Dynamic Part)
          MATCHING_OPTION_ID=""
          for TOPIC in $TOPICS; do
            # Convert "wp-product" -> "WP Product" or "meta" -> "Meta"
            # This makes the matching case-insensitive and space-friendly
            FORMATTED_TOPIC=$(echo "$TOPIC" | sed -r 's/(^|-)([a-z])/\1\U\2/g' | sed 's/-/ /g' | sed 's/Wp/WP/g')
            
            echo "Checking if '$FORMATTED_TOPIC' exists on board..."
            OPTION_ID=$(echo "$PILLAR_OPTIONS" | jq -r ".[] | select(.name == \"$FORMATTED_TOPIC\") | .id")
            
            if [ "$OPTION_ID" != "" ]; then
              MATCHING_OPTION_ID="$OPTION_ID"
              echo "✅ Match found: $FORMATTED_TOPIC"
              break
            fi
          done

          # 5. Apply the Pillar if a match was found
          if [ -n "$MATCHING_OPTION_ID" ]; then
            gh project item-edit --id "$ITEM_ID" --project-id "$PROJECT_ID" --field-id "$FIELD_ID" --single-select-option-id "$MATCHING_OPTION_ID"
          else
            echo "ℹ️ No repository topics matched a Pillar name. Issue stays in 'No Pillar'."
          fi